---
title: "Car Ownership Cost Analysis"
authors: "Geisol and Maria"
format: html
editor: visual
---

# Introduction

In this project we combine web‑scraped car adverts (Blocket), data from **Transportstyrelsen**, and insurance quotes to estimate the yearly cost of car ownership and identify the factors that drive that cost.

```{r setup, message=FALSE, warning=FALSE}
# Install once (comment‑out in final document)
# install.packages(c("fastDummies","corrplot","rsample","GGally","ggcorrplot"))

library(tidyverse)
library(readxl)
library(fastDummies)
library(corrplot)
library(rsample)
library(GGally)
library(ggcorrplot)
library(car)        # vif()
library(stringr)    # str_detect()
```

# Data Import & Cleaning

```{r}
# Load the Excel file
auto_path <- "dataset_final.xlsx"
cars_raw  <- read_excel(auto_path)

# Convert numeric‑looking strings → numeric, keep others as is
cars_clean <- cars_raw %>%
  mutate(across(where(is.character),
         ~ if_else(str_detect(.x, "^[0-9.,]+$"),
                    as.numeric(str_replace_all(.x, ",", "")), .x))) %>%
  mutate(`Energiförbrukning (Wh/km)` = replace_na(as.numeric(`Energiförbrukning (Wh/km)`), 0))
```

# Feature Engineering

```{r}
# Annual depreciation and loan interest
cars_clean <- cars_clean %>%
  mutate(`Värdeminskning (kr) per år` = round(`Pris (kr)` * 0.15),
         `Lån (kr) per år`           = round(`Pris (kr)` * 0.80 * 0.0745))

# Fuel / energy prices (kr)
pris_bensin <- 15.54
pris_diesel <- 16.59
pris_el     <-  1.50

# Helper indices
bensin  <- str_detect(cars_clean$Bränsle, "Bensin")
diesel  <- str_detect(cars_clean$Bränsle, "Diesel")
hybrid  <- str_detect(cars_clean$Bränsle, "Miljöbränsle|Hybrid")
elbil   <- !is.na(cars_clean$`Energiförbrukning (Wh/km)`) &
           is.na(cars_clean$`Bränsleförbrukning (l / 100 km)`)
laddhyb <- !is.na(cars_clean$`Energiförbrukning (Wh/km)`) &
           !is.na(cars_clean$`Bränsleförbrukning (l / 100 km)`)

cars_clean <- cars_clean %>% mutate(`Drivmedelskostnad (kr) för 10000 km` = NA_real_)

cars_clean$`Drivmedelskostnad (kr) för 10000 km`[bensin] <-
  round(cars_clean$`Bränsleförbrukning (l / 100 km)`[bensin] * 100 * pris_bensin)

cars_clean$`Drivmedelskostnad (kr) för 10000 km`[diesel] <-
  round(cars_clean$`Bränsleförbrukning (l / 100 km)`[diesel] * 100 * pris_diesel)

cars_clean$`Drivmedelskostnad (kr) för 10000 km`[hybrid] <-
  round(cars_clean$`Bränsleförbrukning (l / 100 km)`[hybrid] * 100 * pris_bensin)

cars_clean$`Drivmedelskostnad (kr) för 10000 km`[elbil] <-
  round((cars_clean$`Energiförbrukning (Wh/km)`[elbil] / 1000) * 10000 * pris_el)

cars_clean$`Drivmedelskostnad (kr) för 10000 km`[laddhyb] <- round(
  (cars_clean$`Energiförbrukning (Wh/km)`[laddhyb] / 1000) * 5000 * pris_el +
  cars_clean$`Bränsleförbrukning (l / 100 km)`[laddhyb] * 50 * pris_bensin)
```

## Dummy Variables & Factors

```{r}
# Bränsle dummies (El = reference)
cars_clean <- dummy_cols(cars_clean, select_columns = "Bränsle", remove_first_dummy = TRUE)
cars_clean$Bränsle <- relevel(factor(cars_clean$Bränsle), ref = "El")

# Consolidate Biltyp
cars_clean <- cars_clean %>%
  mutate(Biltyp = case_when(
    Biltyp %in% c("Halvkombi","Kombi","Sedan")               ~ "Personbil",
    Biltyp %in% c("SUV","Familjebuss","Yrkesfordon","Skåpbil") ~ "Storbil",
    Biltyp %in% c("Coupé","Cab")                               ~ "Sportbil",
    TRUE                                                          ~ "Annat"),
         Biltyp = factor(Biltyp))
```

# Log‑Transforms & Modelling Data

```{r}
cars_inf <- cars_clean %>%
  mutate(Helförsäkring_log = log(`Helförsäkring (kr / år)`),
         Pris_log           = log(`Pris (kr)`),
         Skatt_log          = log(`Fordonsskatt (kr / år)` + 1),
         Mätar_log          = log(`Mätarställning (km)` + 1),
         CO2_log            = log(`Koldioxidutsläpp blandad (NEDC) g/km` + 1),
         Bränsleförb_log    = log(`Bränsleförbrukning (l / 100 km)` + 1)) %>%
  select(Helförsäkring_log, Hästkrafter, Modellår, Mätar_log, CO2_log,
         Bränsleförb_log, Bränsle, Biltyp, Pris_log, Skatt_log)
```

# Insurance‑Cost Model

```{r}
model_f <- lm(Helförsäkring_log ~ ., data = cars_inf)
summary(model_f)
confint(model_f)
```

```{r}
# Check multicollinearity
vif(model_f)
```

```{r fig.width=6, fig.height=6}
# Diagnostics including Q‑Q plot
par(mfrow = c(2, 2))
plot(model_f)
par(mfrow = c(1, 1))
```

# Key Findings

* **Hästkrafter (β ≈ 0.55)** – 10 % fler hk höjer försäkringen ≈ 5 – 6 %.
* **Pris (β ≈ 0.16)** – 10 % högre bilpris höjer försäkringen ≈ 1,6 %.
* **Modellår** och **körsträcka** har mindre, men signifikanta effekter.
* Residual‑ och Q‑Q‑diagram visar i huvudsak normala, homoskedastiska fel.

---

*End of Quarto document*