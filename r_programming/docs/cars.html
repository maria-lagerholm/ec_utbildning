<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Geisol">
<meta name="author" content="Maria">

<title>Blocket Car Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="cars_files/libs/clipboard/clipboard.min.js"></script>
<script src="cars_files/libs/quarto-html/quarto.js"></script>
<script src="cars_files/libs/quarto-html/popper.min.js"></script>
<script src="cars_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="cars_files/libs/quarto-html/anchor.min.js"></script>
<link href="cars_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="cars_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="cars_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="cars_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="cars_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Blocket Car Analysis</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Geisol </p>
             <p>Maria </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In this project, we analyze web-scraped used car listings from Blocket, enriched with technical specifications from Transportstyrelsen and cost estimates for insurance and taxation in Sweden. The primary goal has shifted from estimating total yearly ownership cost to two main objectives: (1) Predicting market prices for used cars in Sweden, with a focus on non-premium, mid-range vehicles, and (2) Gaining statistical insight into what factors influence insurance premiums and vehicle taxes, using linear regression models.</p>
<p>By combining predictive modeling (e.g., random forest) with inference-driven approaches (e.g., linear regression), we aim to both improve price prediction accuracy and interpret underlying patterns in insurance and tax structures in the Swedish car market.</p>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tidyverse"</span>, <span class="st">"readxl"</span>, <span class="st">"fastDummies"</span>, <span class="st">"corrplot"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"rsample"</span>, <span class="st">"GGally"</span>, <span class="st">"ggcorrplot"</span>, <span class="st">"car"</span>, <span class="st">"xgboost"</span>, <span class="st">"yardstick"</span>, <span class="st">"tibble"</span>, <span class="st">"ranger"</span>, <span class="st">"glmnet"</span>, <span class="st">"vip"</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> packages <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>())</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span>idx)) <span class="fu">install.packages</span>(packages[<span class="sc">!</span>idx])</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">lapply</span>(packages, library, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the data (adjust file name/path if needed) -------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>cars_raw <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"dataset_final.xlsx"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Convert character columns that look numeric into numeric --------------</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>cars_clean <span class="ot">&lt;-</span> cars_raw <span class="sc">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">where</span>(is.character),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">ifelse</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grepl</span>(<span class="st">"^[0-9.,]+$"</span>, .x),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">","</span>, <span class="st">""</span>, .x))),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        .x</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Convert energy consumption to numeric and replace NAs with 0 --------</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Energiförbrukning (Wh/km)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">replace_na</span>(<span class="fu">as.numeric</span>(<span class="st">`</span><span class="at">Energiförbrukning (Wh/km)</span><span class="st">`</span>), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Convert Modellår to factor ------------------------------------------</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(Modellår <span class="ot">=</span> <span class="fu">factor</span>(Modellår)) <span class="sc">%&gt;%</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Remove Biltyp completely --------------------------------------------</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Biltyp)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(cars_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 567
Columns: 15
$ Annons                                 &lt;chr&gt; "Volkswagen", "Ford Kuga 2.0 TD…
$ Fordonsbenämning                       &lt;chr&gt; "VOLKSWAGEN T-ROC", "FORD KUGA"…
$ Handelsbeteckning                      &lt;chr&gt; "T-ROC", "KUGA", "A3 SPORTBACK"…
$ Registreringsnummer                    &lt;chr&gt; "TNG159", "GJD48X", "LRO335", "…
$ `Fordonsskatt (kr / år)`               &lt;dbl&gt; 536, 3886, 360, 1103, 3084, 308…
$ Bränsle                                &lt;chr&gt; "Miljöbränsle/Hybrid", "Diesel"…
$ `Helförsäkring (kr / år)`              &lt;dbl&gt; 3264, 4140, 3984, 3528, 4164, 8…
$ Hästkrafter                            &lt;dbl&gt; 111, 150, 116, 100, 170, 392, 1…
$ `Mätarställning (km)`                  &lt;dbl&gt; 90000, 137420, 52000, 248215, 3…
$ Modellår                               &lt;fct&gt; 2018, 2019, 2017, 2016, 2015, 2…
$ `Bränsleförbrukning (l / 100 km)`      &lt;dbl&gt; 5.2, 6.1, 4.7, 4.2, 5.7, 1.7, 5…
$ `Koldioxidutsläpp blandad (NEDC) g/km` &lt;dbl&gt; 119, 161, 107, 109, 149, 51, 14…
$ `Energiförbrukning (Wh/km)`            &lt;dbl&gt; 0, 0, 0, 0, 0, 149, 0, 160, 0, …
$ `Pris (kr)`                            &lt;dbl&gt; 135000, 160000, 154000, 50000, …
$ Url                                    &lt;chr&gt; "https://www.blocket.se/annons/…</code></pre>
</div>
</div>
<p>#Distribution inspection</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualise distributions of all numeric variables -----------------------</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>numeric_vars <span class="ot">&lt;-</span> cars_clean <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(is.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(<span class="sc">~</span> <span class="fu">n_distinct</span>(.) <span class="sc">&gt;</span> <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"Variable"</span>, <span class="at">values_to =</span> <span class="st">"Value"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(numeric_vars, <span class="fu">aes</span>(Value)) <span class="sc">+</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Variable, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cars_files/figure-html/distribution-check-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Final modelling dataset -------------------------------------------------</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>cars_clean_inf <span class="ot">&lt;-</span> cars_clean <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    Helförsäkring<span class="at">_log =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">Helförsäkring (kr / år)</span><span class="st">`</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    Hästkrafter<span class="at">_log        =</span> <span class="fu">log</span>(Hästkrafter <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Pris_log          =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">Pris (kr)</span><span class="st">`</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Skatt_log         =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">Fordonsskatt (kr / år)</span><span class="st">`</span> <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    Mätar<span class="at">_log         =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">Mätarställning (km)</span><span class="st">`</span> <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    Bränsleförb<span class="at">_log   =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">Bränsleförbrukning (l / 100 km)</span><span class="st">`</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    Helförsäkring_log, Hästkrafter_log, Modellår, Mätar_log,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    Bränsleförb_log, Bränsle, Pris_log, Skatt_log, <span class="st">`</span><span class="at">Koldioxidutsläpp blandad (NEDC) g/km</span><span class="st">`</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(cars_clean_inf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 567
Columns: 9
$ Helförsäkring_log                      &lt;dbl&gt; 8.090709, 8.328451, 8.290042, 8…
$ Hästkrafter_log                        &lt;dbl&gt; 4.718499, 5.017280, 4.762174, 4…
$ Modellår                               &lt;fct&gt; 2018, 2019, 2017, 2016, 2015, 2…
$ Mätar_log                              &lt;dbl&gt; 11.40758, 11.83080, 10.85902, 1…
$ Bränsleförb_log                        &lt;dbl&gt; 1.8245493, 1.9600948, 1.7404662…
$ Bränsle                                &lt;chr&gt; "Miljöbränsle/Hybrid", "Diesel"…
$ Pris_log                               &lt;dbl&gt; 11.81303, 11.98293, 11.94471, 1…
$ Skatt_log                              &lt;dbl&gt; 6.285998, 8.265393, 5.888878, 7…
$ `Koldioxidutsläpp blandad (NEDC) g/km` &lt;dbl&gt; 119, 161, 107, 109, 149, 51, 14…</code></pre>
</div>
</div>
<section id="correlation-inspection" class="level2">
<h2 class="anchored" data-anchor-id="correlation-inspection">Correlation inspection</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cars_clean_inf <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(is.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">cor</span>(.x, cars_clean_inf<span class="sc">$</span>Helförsäkring_log, <span class="at">use =</span> <span class="st">"complete.obs"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"Variable"</span>, <span class="at">values_to =</span> <span class="st">"Correlation"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(Correlation)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
  Variable                             Correlation
  &lt;chr&gt;                                      &lt;dbl&gt;
1 Helförsäkring_log                         1     
2 Hästkrafter_log                           0.641 
3 Pris_log                                  0.491 
4 Skatt_log                                 0.328 
5 Koldioxidutsläpp blandad (NEDC) g/km      0.177 
6 Mätar_log                                 0.175 
7 Bränsleförb_log                           0.0522</code></pre>
</div>
</div>
</section>
</section>
<section id="statistical-inference" class="level1">
<h1>Statistical Inference</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>model_f <span class="ot">&lt;-</span> <span class="fu">lm</span>(Helförsäkring_log <span class="sc">~</span> ., <span class="at">data =</span> cars_clean_inf<span class="sc">%&gt;%</span><span class="fu">select</span>(<span class="sc">-</span>Bränsleförb_log, <span class="sc">-</span>Skatt_log, <span class="sc">-</span><span class="st">`</span><span class="at">Koldioxidutsläpp blandad (NEDC) g/km</span><span class="st">`</span>))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Helförsäkring_log ~ ., data = cars_clean_inf %&gt;% 
    select(-Bränsleförb_log, -Skatt_log, -`Koldioxidutsläpp blandad (NEDC) g/km`))

Residuals:
     Min       1Q   Median       3Q      Max 
-1.62613 -0.13991  0.01238  0.14633  1.12691 

Coefficients:
                            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                 4.425059   0.355816  12.436  &lt; 2e-16 ***
Hästkrafter_log             0.673330   0.043156  15.602  &lt; 2e-16 ***
Modellår2016                0.130499   0.040766   3.201 0.001448 ** 
Modellår2017                0.084723   0.042999   1.970 0.049300 *  
Modellår2018                0.175707   0.045889   3.829 0.000143 ***
Modellår2019                0.189512   0.051514   3.679 0.000257 ***
Modellår2020                0.122110   0.057830   2.112 0.035176 *  
Modellår2021                0.105902   0.067657   1.565 0.118090    
Modellår2022               -0.320774   0.080153  -4.002 7.14e-05 ***
Modellår2023               -0.767089   0.101016  -7.594 1.34e-13 ***
Modellår2024               -0.666266   0.144128  -4.623 4.72e-06 ***
Mätar_log                  -0.002024   0.016187  -0.125 0.900519    
BränsleDiesel               0.191398   0.030503   6.275 7.09e-10 ***
BränsleEl                   0.148035   0.052617   2.813 0.005076 ** 
BränsleMiljöbränsle/Hybrid -0.039388   0.047873  -0.823 0.411004    
Pris_log                    0.088860   0.034501   2.576 0.010267 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.2893 on 551 degrees of freedom
Multiple R-squared:  0.6089,    Adjusted R-squared:  0.5982 
F-statistic: 57.19 on 15 and 551 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(model_f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                   2.5 %      97.5 %
(Intercept)                 3.7261375286  5.12398106
Hästkrafter_log             0.5885590978  0.75810107
Modellår2016                0.0504226542  0.21057577
Modellår2017                0.0002605098  0.16918554
Modellår2018                0.0855680936  0.26584602
Modellår2019                0.0883236695  0.29070109
Modellår2020                0.0085155506  0.23570527
Modellår2021               -0.0269944559  0.23879814
Modellår2022               -0.4782159558 -0.16333214
Modellår2023               -0.9655113110 -0.56866605
Modellår2024               -0.9493729123 -0.38315816
Mätar_log                  -0.0338211684  0.02977225
BränsleDiesel               0.1314817013  0.25131371
BränsleEl                   0.0446815413  0.25138920
BränsleMiljöbränsle/Hybrid -0.1334234613  0.05464811
Pris_log                    0.0210903071  0.15662998</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostics -------------------------------------------------------------</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cars_files/figure-html/inference-models-pris-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(model_f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    GVIF Df GVIF^(1/(2*Df))
Hästkrafter_log 2.297543  1        1.515765
Modellår        2.771852  9        1.058275
Mätar_log       1.371131  1        1.170953
Bränsle         1.945106  3        1.117268
Pris_log        2.612827  1        1.616424</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model_p <span class="ot">&lt;-</span> <span class="fu">lm</span>(Pris_log <span class="sc">~</span> .,  <span class="at">data =</span> cars_clean_inf <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Helförsäkring_log, <span class="sc">-</span>Skatt_log, <span class="sc">-</span>Bränsleförb_log, <span class="sc">-</span><span class="st">`</span><span class="at">Koldioxidutsläpp blandad (NEDC) g/km</span><span class="st">`</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Pris_log ~ ., data = cars_clean_inf %&gt;% select(-Helförsäkring_log, 
    -Skatt_log, -Bränsleförb_log, -`Koldioxidutsläpp blandad (NEDC) g/km`))

Residuals:
    Min      1Q  Median      3Q     Max 
-4.1289 -0.1412  0.0117  0.1672  1.2578 

Coefficients:
                           Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                 7.97794    0.27817  28.680  &lt; 2e-16 ***
Hästkrafter_log             0.85867    0.03871  22.180  &lt; 2e-16 ***
Modellår2016                0.17899    0.04971   3.601 0.000346 ***
Modellår2017                0.29481    0.05154   5.720 1.75e-08 ***
Modellår2018                0.42122    0.05370   7.844 2.27e-14 ***
Modellår2019                0.52904    0.05943   8.902  &lt; 2e-16 ***
Modellår2020                0.58078    0.06692   8.678  &lt; 2e-16 ***
Modellår2021                0.62544    0.07911   7.906 1.45e-14 ***
Modellår2022                0.80881    0.09269   8.726  &lt; 2e-16 ***
Modellår2023                0.55309    0.12238   4.520 7.58e-06 ***
Modellår2024               -0.00749    0.17780  -0.042 0.966413    
Mätar_log                  -0.05252    0.01984  -2.647 0.008359 ** 
BränsleDiesel               0.03504    0.03760   0.932 0.351811    
BränsleEl                  -0.25781    0.06398  -4.030 6.37e-05 ***
BränsleMiljöbränsle/Hybrid -0.09491    0.05892  -1.611 0.107791    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3569 on 552 degrees of freedom
Multiple R-squared:  0.6173,    Adjusted R-squared:  0.6076 
F-statistic: 63.59 on 14 and 552 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(model_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                 2.5 %      97.5 %
(Intercept)                 7.43153296  8.52434776
Hästkrafter_log             0.78262906  0.93472049
Modellår2016                0.08134198  0.27663646
Modellår2017                0.19356705  0.39604896
Modellår2018                0.31574592  0.52670025
Modellår2019                0.41230182  0.64576999
Modellår2020                0.44932546  0.71223827
Modellår2021                0.47005000  0.78082332
Modellår2022                0.62673511  0.99089234
Modellår2023                0.31271333  0.79347083
Modellår2024               -0.35674788  0.34176737
Mätar_log                  -0.09150270 -0.01354318
BränsleDiesel              -0.03881892  0.10889687
BränsleEl                  -0.38348139 -0.13214465
BränsleMiljöbränsle/Hybrid -0.21064723  0.02082572</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostics -------------------------------------------------------------</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cars_files/figure-html/inference-models-försäkring-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(model_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    GVIF Df GVIF^(1/(2*Df))
Hästkrafter_log 1.214864  1        1.102209
Modellår        2.102262  9        1.042142
Mätar_log       1.353948  1        1.163593
Bränsle         1.869131  3        1.109873</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>model_s <span class="ot">&lt;-</span> <span class="fu">lm</span>(Skatt_log <span class="sc">~</span> .,  <span class="at">data =</span> cars_clean_inf <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Helförsäkring_log, <span class="sc">-</span>Bränsleförb_log))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Skatt_log ~ ., data = cars_clean_inf %&gt;% select(-Helförsäkring_log, 
    -Bränsleförb_log))

Residuals:
     Min       1Q   Median       3Q      Max 
-1.73571 -0.17956  0.00722  0.14782  2.14602 

Coefficients:
                                         Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)                             3.7474036  0.3921125   9.557  &lt; 2e-16
Hästkrafter_log                         0.0844377  0.0480966   1.756  0.07972
Modellår2016                           -0.0086872  0.0444502  -0.195  0.84512
Modellår2017                           -0.0051490  0.0468984  -0.110  0.91261
Modellår2018                            0.0722257  0.0500423   1.443  0.14951
Modellår2019                            0.1370839  0.0561549   2.441  0.01495
Modellår2020                            0.3889436  0.0636855   6.107 1.92e-09
Modellår2021                            0.4169018  0.0744365   5.601 3.37e-08
Modellår2022                            0.6054214  0.0878560   6.891 1.52e-11
Modellår2023                            0.5350574  0.1107225   4.832 1.75e-06
Modellår2024                            0.4453881  0.1588154   2.804  0.00522
Mätar_log                              -0.0155264  0.0176585  -0.879  0.37964
BränsleDiesel                           1.0983733  0.0333746  32.910  &lt; 2e-16
BränsleEl                               0.8811862  0.0912131   9.661  &lt; 2e-16
BränsleMiljöbränsle/Hybrid              0.0799366  0.0632723   1.263  0.20699
Pris_log                                0.0571287  0.0382993   1.492  0.13637
`Koldioxidutsläpp blandad (NEDC) g/km`  0.0140908  0.0005157  27.325  &lt; 2e-16
                                          
(Intercept)                            ***
Hästkrafter_log                        .  
Modellår2016                              
Modellår2017                              
Modellår2018                              
Modellår2019                           *  
Modellår2020                           ***
Modellår2021                           ***
Modellår2022                           ***
Modellår2023                           ***
Modellår2024                           ** 
Mätar_log                                 
BränsleDiesel                          ***
BränsleEl                              ***
BränsleMiljöbränsle/Hybrid                
Pris_log                                  
`Koldioxidutsläpp blandad (NEDC) g/km` ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3154 on 550 degrees of freedom
Multiple R-squared:  0.8785,    Adjusted R-squared:  0.8749 
F-statistic: 248.5 on 16 and 550 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(model_s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                             2.5 %     97.5 %
(Intercept)                             2.97718221 4.51762494
Hästkrafter_log                        -0.01003789 0.17891332
Modellår2016                           -0.09600011 0.07862564
Modellår2017                           -0.09727096 0.08697288
Modellår2018                           -0.02607178 0.17052317
Modellår2019                            0.02677966 0.24738819
Modellår2020                            0.26384709 0.51404009
Modellår2021                            0.27068714 0.56311646
Modellår2022                            0.43284702 0.77799588
Modellår2023                            0.31756674 0.75254800
Modellår2024                            0.13342917 0.75734694
Mätar_log                              -0.05021281 0.01915995
BränsleDiesel                           1.03281599 1.16393053
BränsleEl                               0.70201754 1.06035478
BränsleMiljöbränsle/Hybrid             -0.04434826 0.20422140
Pris_log                               -0.01810205 0.13235953
`Koldioxidutsläpp blandad (NEDC) g/km`  0.01307782 0.01510370</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostics -------------------------------------------------------------</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cars_files/figure-html/inference-models-skatt-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(model_s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                           GVIF Df GVIF^(1/(2*Df))
Hästkrafter_log                        2.401534  1        1.549688
Modellår                               2.935802  9        1.061658
Mätar_log                              1.373134  1        1.171808
Bränsle                                5.360547  3        1.322924
Pris_log                               2.709625  1        1.646094
`Koldioxidutsläpp blandad (NEDC) g/km` 3.920598  1        1.980050</code></pre>
</div>
</div>
</section>
<section id="predictive-modeling" class="level1">
<h1>Predictive Modeling</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fastDummies)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(yardstick)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Data Preparation (log-transformations &amp; dummy vars)</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Define log-transform target columns</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>log_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pris_log"</span>, </span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fordonsskatt_log"</span>, </span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"helforsakring_log"</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"hastkrafter_log"</span>,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"matarstallning_log"</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean and transform the dataset</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>cars_price <span class="ot">&lt;-</span> cars_clean <span class="sc">%&gt;%</span> </span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    id,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">fordonsbenamning =</span> Fordonsbenämning,</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">handelsbeteckning =</span> Handelsbeteckning,</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">pris =</span> <span class="st">`</span><span class="at">Pris (kr)</span><span class="st">`</span>,</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">pris_log =</span> <span class="fu">log</span>(pris),</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">fordonsskatt_log =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">Fordonsskatt (kr / år)</span><span class="st">`</span> <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">helforsakring_log =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">Helförsäkring (kr / år)</span><span class="st">`</span> <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">hastkrafter_log =</span> <span class="fu">log</span>(Hästkrafter <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">matarstallning_log =</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">Mätarställning (km)</span><span class="st">`</span> <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">#co2 = `Koldioxidutsläpp blandad (NEDC) g/km`</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>()</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Compute outlier thresholds before splitting</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>compute_outlier_bounds <span class="ot">&lt;-</span> <span class="cf">function</span>(df, columns, <span class="at">lower =</span> <span class="fl">0.01</span>, <span class="at">upper =</span> <span class="fl">0.99</span>) {</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(columns, <span class="cf">function</span>(col) {</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">variable =</span> col,</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">q_low =</span> <span class="fu">quantile</span>(df[[col]], lower, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">q_high =</span> <span class="fu">quantile</span>(df[[col]], upper, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>apply_outlier_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(df, bounds) {</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(bounds))) {</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>    col <span class="ot">&lt;-</span> bounds<span class="sc">$</span>variable[i]</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(.data[[col]] <span class="sc">&gt;=</span> bounds<span class="sc">$</span>q_low[i], .data[[col]] <span class="sc">&lt;=</span> bounds<span class="sc">$</span>q_high[i])</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>outlier_bounds <span class="ot">&lt;-</span> <span class="fu">compute_outlier_bounds</span>(cars_price, log_vars)</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Initial Split (80/20) stratified by log(price)</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(cars_price, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">strata =</span> pris_log)</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">training</span>(split)</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>test  <span class="ot">&lt;-</span> <span class="fu">testing</span>(split)</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply outlier removal</span></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">apply_outlier_filter</span>(train, outlier_bounds)</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>test  <span class="ot">&lt;-</span> <span class="fu">apply_outlier_filter</span>(test, outlier_bounds)</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Hyperparameter Grid Search via 5-fold Cross-validation</span></span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(train, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">strata =</span> pris_log)</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees     =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">200</span>),</span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry          =</span> <span class="fu">floor</span>(<span class="fu">ncol</span>(train)<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.node.size =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">max.depth     =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">12</span>)</span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>cv_results <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dfr</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(param_grid)), <span class="cf">function</span>(i) {</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_grid[i, ]</span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>  fold_metrics <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(folds<span class="sc">$</span>splits, <span class="cf">function</span>(spl) {</span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>    tr <span class="ot">&lt;-</span> <span class="fu">analysis</span>(spl)</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>    va <span class="ot">&lt;-</span> <span class="fu">assessment</span>(spl)</span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>      pris_log <span class="sc">~</span> .,</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>      <span class="at">data          =</span> tr <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>fordonsbenamning, <span class="sc">-</span>handelsbeteckning, <span class="sc">-</span>pris),</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>      <span class="at">num.trees     =</span> p<span class="sc">$</span>num.trees,</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>      <span class="at">mtry          =</span> p<span class="sc">$</span>mtry,</span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">min.node.size =</span> p<span class="sc">$</span>min.node.size,</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.depth     =</span> p<span class="sc">$</span>max.depth</span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, va)<span class="sc">$</span>predictions</span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rmse_vec</span>(<span class="at">truth =</span> va<span class="sc">$</span>pris_log, <span class="at">estimate =</span> pred)</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">num.trees     =</span> p<span class="sc">$</span>num.trees,</span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry          =</span> p<span class="sc">$</span>mtry,</span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.node.size =</span> p<span class="sc">$</span>min.node.size,</span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.depth     =</span> p<span class="sc">$</span>max.depth,</span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE_log_CV   =</span> <span class="fu">mean</span>(fold_metrics)</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Select best hyperparameters based on CV</span></span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>best_params <span class="ot">&lt;-</span> cv_results <span class="sc">%&gt;%</span> </span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(RMSE_log_CV, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Train final model on entire training set</span></span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a>final_model <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a>  pris_log <span class="sc">~</span> .,</span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a>  <span class="at">data          =</span> train <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>fordonsbenamning, <span class="sc">-</span>handelsbeteckning, <span class="sc">-</span>pris),</span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees     =</span> best_params<span class="sc">$</span>num.trees,</span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry          =</span> best_params<span class="sc">$</span>mtry,</span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.node.size =</span> best_params<span class="sc">$</span>min.node.size,</span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>  <span class="at">max.depth     =</span> best_params<span class="sc">$</span>max.depth,</span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">importance    =</span> <span class="st">"impurity"</span></span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Evaluate RMSE (final hold-out test set)</span></span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions on test set (hold-out)</span></span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a>test_pred_log <span class="ot">&lt;-</span> <span class="fu">predict</span>(final_model, test)<span class="sc">$</span>predictions</span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a>test_pred_sek <span class="ot">&lt;-</span> <span class="fu">exp</span>(test_pred_log)</span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate RMSE for test set</span></span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a>rmse_test_log <span class="ot">&lt;-</span> <span class="fu">rmse_vec</span>(test<span class="sc">$</span>pris_log, test_pred_log)</span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a>rmse_test_sek <span class="ot">&lt;-</span> <span class="fu">rmse_vec</span>(test<span class="sc">$</span>pris, test_pred_sek)</span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute SEK equivalent of the CV RMSE_log (0.228)</span></span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Using mean predicted price (SEK) from test set as scaling factor</span></span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a>mean_test_pred_sek <span class="ot">&lt;-</span> <span class="fu">mean</span>(test_pred_sek)</span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a>rmse_cv_sek_equiv <span class="ot">&lt;-</span> mean_test_pred_sek <span class="sc">*</span> best_params<span class="sc">$</span>RMSE_log_CV</span>
<span id="cb30-152"><a href="#cb30-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-153"><a href="#cb30-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 8: Results (CV vs. Test)</span></span>
<span id="cb30-154"><a href="#cb30-154" aria-hidden="true" tabindex="-1"></a>results_summary <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb30-155"><a href="#cb30-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">Dataset  =</span> <span class="fu">c</span>(<span class="st">"5-fold CV (grid-search)"</span>, <span class="st">"Test set (hold-out)"</span>),</span>
<span id="cb30-156"><a href="#cb30-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE_log =</span> <span class="fu">round</span>(<span class="fu">c</span>(best_params<span class="sc">$</span>RMSE_log_CV, rmse_test_log), <span class="dv">4</span>),</span>
<span id="cb30-157"><a href="#cb30-157" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE_SEK =</span> <span class="fu">round</span>(<span class="fu">c</span>(rmse_cv_sek_equiv, rmse_test_sek), <span class="dv">0</span>)</span>
<span id="cb30-158"><a href="#cb30-158" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-159"><a href="#cb30-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-160"><a href="#cb30-160" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(results_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  Dataset                 RMSE_log RMSE_SEK
  &lt;chr&gt;                      &lt;dbl&gt;    &lt;dbl&gt;
1 5-fold CV (grid-search)    0.231    44297
2 Test set (hold-out)        0.235    56829</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 9: Residual Analysis – overpriced vs. underpriced cars</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>test_results <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_log =</span> test_pred_log,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_sek =</span> test_pred_sek,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_sek =</span> pris <span class="sc">-</span> pred_sek,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_pct =</span> <span class="dv">100</span> <span class="sc">*</span> diff_sek <span class="sc">/</span> pred_sek</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, fordonsbenamning, handelsbeteckning, pris, pred_sek, diff_sek, diff_pct)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>overpriced  <span class="ot">&lt;-</span> test_results <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(diff_sek)) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">5</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>underpriced <span class="ot">&lt;-</span> test_results <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(diff_sek) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">5</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top 5 Overpriced Cars:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Top 5 Overpriced Cars:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(overpriced)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
     id fordonsbenamning     handelsbeteckning   pris pred_sek diff_sek diff_pct
  &lt;int&gt; &lt;chr&gt;                &lt;chr&gt;              &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1   481 KIA EV9              EV9               735000  420156.  314844.     74.9
2   333 BMW X5 XDRIVE45E     X5 XDRIVE45E      560000  360145.  199855.     55.5
3   269 MERCEDES-BENZ V-KLA… V-KLASSE          469000  329714.  139286.     42.2
4   360 SUBARU OUTBACK       OUTBACK           305000  185964.  119036.     64.0
5   478 VOLVO                XC60              270000  166502.  103498.     62.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top 5 Underpriced Cars:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Top 5 Underpriced Cars:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(underpriced)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
     id fordonsbenamning     handelsbeteckning   pris pred_sek diff_sek diff_pct
  &lt;int&gt; &lt;chr&gt;                &lt;chr&gt;              &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1   327 VOLVO V60            V60               329900  417784.  -87884.    -21.0
2    64 TESLA MODEL 3        MODEL 3           270000  354375.  -84375.    -23.8
3   390 MITSUBISHI OUTLANDER MITSUBISHI OUTLA… 208000  284415.  -76415.    -26.9
4     7 BMW X1 XDRIVE20D     X1 XDRIVE20D      164900  237757.  -72857.    -30.6
5   280 MERCEDES-BENZ AMG C… AMG CLA 45        285000  357659.  -72659.    -20.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 10: Variable importance visualization</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">vip</span>(final_model, <span class="at">num_features =</span> <span class="dv">10</span>, <span class="at">bar =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cars_files/figure-html/rf-price-prediction-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>